#### EAM系统架构之二：MySQL主从同步

MySQL主从同步的主要步骤：
* 在主服务器上开启bin-log二进制日志功能，设置唯一的server_id(除了多实例外一般设置为ip地址最后一位)，设置完成重启mysqld服务
* 在从服务器上同样设置唯一的server_id
* 在主服务器上授权REPLICATION SLAVE权限，允许从服务器同步数据
* 复制数据前在主服务器上SHOW MASTER STATUS记录file和position

##### 1. 编辑mysql配置文件my.cnf

在MySQL_Master_Node01服务器上开启二进制日志功能并且制定相应的server_id
可以参考配置文件如下：
```language
[root@MySQL_Slaver_Node01 ~]# cat /usr/share/mysql/my-default.cnf 
# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html
# *** DO NOT EDIT THIS FILE. It's a template which will be copied to the
# *** default location during install, and will be replaced if you
# *** upgrade to a newer version of MySQL.

[mysqld]

# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
# innodb_buffer_pool_size = 128M

# Remove leading # to turn on a very important data integrity option: logging
# changes to the binary log between backups.
# log_bin #开启二进制日志功能

# These are commonly set, remove the # and set as required.
# basedir = .....
# datadir = .....
# port = .....
# server_id = ..... #一般指定为IP地址最后一位或者两位
# socket = .....

# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
# join_buffer_size = 128M
# sort_buffer_size = 2M
# read_rnd_buffer_size = 2M 

sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES
```
具体配置如下：
```language
[root@MySQL_Slaver_Node01 ~]# vim /etc/my.cnf

# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html

[mysqld]
#
# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
# innodb_buffer_pool_size = 128M
#
# Remove leading # to turn on a very important data integrity option: logging
# changes to the binary log between backups.
log_bin=replicate.bin #日志文件名可以随意设置
#
# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
# join_buffer_size = 128M
# sort_buffer_size = 2M
# read_rnd_buffer_size = 2M
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock
server_id=130
# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links=0

log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid
```
同样在从服务器也可以开启二进制日志功能提供给后续的备份使用

##### 2. 创建相应的MySQL账户用于同步数据

用于同步数据库的账户必须具备REPLICATION SLAVE权限
```language
mysql> GRANT REPLICATION SLAVE ON *.* TO 'replicate'@'%' identified by 'P@ssw0rd';
Query OK, 0 rows affected, 1 warning (0.04 sec)

mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.01 sec)
```
获取主数据库的二进制信息
```language
mysql> FLUSH TABLES WITH READ LOCK; #锁定数据库表防止用户进行写操作，导致不一致
Query OK, 0 rows affected (0.19 sec)

mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.01 sec)

mysql> SHOW MASTER STATUS;
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| replicate.000001 |      594 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)

mysql> UNLOCK TABLES;
Query OK, 0 rows affected (0.00 sec)
```

##### 3. 对主数据库上已存在数据库文件进行备份

对主数据库上的文件进行备份后到从数据库还原是为了保证主从数据库的一致性，如果主从数据库都为新数据库，则不存在此步骤

```language
[root@MySQL_Master_Node01 ~]# mysqldump -uroot -p --all-databases --lock-all-tables > /tmp/replicate.sql
Enter password: 
[root@MySQL_Master_Node01 ~]# ls /tmp/replicate.sql 
/tmp/replicate.sql
[root@MySQL_Master_Node01 ~]# scp /tmp/replicate.sql root@192.168.42.131:/tmp/
The authenticity of host '192.168.42.131 (192.168.42.131)' can't be established.
RSA key fingerprint is 0f:9f:86:1d:73:0f:24:a2:bf:4c:aa:cf:c8:93:fd:db.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.42.131' (RSA) to the list of known hosts.
root@192.168.42.131's password: 
replicate.sql                                                                          100%  755KB 754.8KB/s   00:00 

[root@MySQL_Slaver_Node01 ~]# mysql -uroot -p < /tmp/replicate.sql 
Enter password: 
```

##### 4. 配置从服务器连接到主服务器进行数据同步

配置连接到主数据库：
```language
mysql> CHANGE MASTER TO
    -> MASTER_HOST='192.168.42.130',
    -> MASTER_USER='replicate',
    -> MASTER_PASSWORD='P@ssw0rd',
    -> MASTER_LOG_FILE='replicate.000001',
    -> MASTER_LOG_POS=594;
Query OK, 0 rows affected, 2 warnings (0.14 sec)
```
开启同步，查看同步状态：
```language
mysql> START SLAVE;
mysql> SHOW SLAVE STATUS \G
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 192.168.42.130
                  Master_User: replicate
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: replicate.000001
          Read_Master_Log_Pos: 734
               Relay_Log_File: MySQL_Slaver_Node01-relay-bin.000002
                Relay_Log_Pos: 460
        Relay_Master_Log_File: replicate.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 734
              Relay_Log_Space: 681
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 130
                  Master_UUID: 157b7051-bafc-11e6-8307-000c2984b209
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)
```
查看到：
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
说明同步进程已经正常开启


